<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detail</title>
    <style>
        .form-field { margin-bottom: 1.5em; }
        .form-field label { display: block; margin-bottom: 0.5em; font-weight: 500; }
        .form-field input[type="text"],
        .form-field input[type="email"],
        .form-field select {
            width: 320px;
            padding: 8px;
            margin-bottom: 0.5em;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        .form-field .radio-group label {
            display: block;
            margin-left: 1.5em;
            margin-bottom: 0.3em;
            font-weight: 400;
        }
        #submitBtn {
            background: green;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 1em;
        }
    </style>
</head>
<body>
    <div id="formPreview"></div>
    <div id="eventList"></div>
</body>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
import { getFirestore, doc, getDoc, collection, addDoc } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";

const firebaseConfig = {
    apiKey: "AIzaSyBAYWnichIFDWP4EOv3RyZFNqzyUtROCeI",
    authDomain: "rsvp-website-7541d.firebaseapp.com",
    projectId: "rsvp-website-7541d",
    storageBucket: "rsvp-website-7541d.appspot.com",
    messagingSenderId: "519298669065",
    appId: "1:519298669065:web:1e43e4c598af256c2636d8",
    measurementId: "G-MWMKYXF18R"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const formPreview = document.getElementById('formPreview');

// Helper: Render field options as array
function getOptionsArray(options) {
    if (Array.isArray(options)) return options;
    if (typeof options === "string") return options.split(',').map(opt => opt.trim()).filter(Boolean);
    return [];
}

// Get event ID from URL
function getEventIdFromUrl() {
    const params = new URLSearchParams(window.location.search);
    return params.get('id');
}

async function showEventDetail() {
    const eventId = getEventIdFromUrl();
    if (!eventId) {
        formPreview.innerHTML = "<p>No event selected.</p>";
        return;
    }
    const docRef = doc(db, "events", eventId);
    const docSnap = await getDoc(docRef);

    if (docSnap.exists()) {
        const event = docSnap.data();
        // Build the form
        const form = document.createElement('form');
        form.id = "eventForm";
        formPreview.innerHTML = `<h2>${event.name}</h2><hr>`;
        formPreview.appendChild(form);

        event.fields.forEach((field, idx) => {
            const wrapper = document.createElement('div');
            wrapper.className = 'form-field';

            // Label
            const label = document.createElement('label');
            label.textContent = field.label;
            label.htmlFor = `field_${idx}`;
            wrapper.appendChild(label);

            // Field types
            if (field.type === 'text' || field.type === 'email') {
                const input = document.createElement('input');
                input.type = field.type;
                input.placeholder = `Enter your ${field.label}`;
                input.id = `field_${idx}`;
                input.name = field.label;
                wrapper.appendChild(input);
            } else if (field.type === 'dropdown') {
                const select = document.createElement('select');
                select.id = `field_${idx}`;
                select.name = field.label;
                const placeholderOption = document.createElement('option');
                placeholderOption.textContent = "Please select";
                placeholderOption.disabled = true;
                placeholderOption.selected = true;
                select.appendChild(placeholderOption);
                getOptionsArray(field.options).forEach(opt => {
                    const option = document.createElement('option');
                    option.value = opt;
                    option.textContent = opt;
                    select.appendChild(option);
                });
                wrapper.appendChild(select);
            } else if (field.type === 'radio') {
                const radioGroup = document.createElement('div');
                radioGroup.className = 'radio-group';
                getOptionsArray(field.options).forEach(opt => {
                    const radioLabel = document.createElement('label');
                    const radio = document.createElement('input');
                    radio.type = "radio";
                    radio.name = field.label;
                    radio.value = opt;
                    radioLabel.appendChild(radio);
                    radioLabel.appendChild(document.createTextNode(" " + opt));
                    radioGroup.appendChild(radioLabel);
                });
                wrapper.appendChild(radioGroup);
            }

            form.appendChild(wrapper);
        });

        // Submit button
        const submitBtn = document.createElement('button');
        submitBtn.type = "submit";
        submitBtn.id = "submitBtn";
        submitBtn.textContent = "Submit";
        form.appendChild(submitBtn);

        // Handle form submission
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const responseData = {
                eventId,
                submittedAt: new Date().toISOString(),
                answers: {}
            };
            event.fields.forEach((field, idx) => {
                let value = "";
                if (field.type === 'text' || field.type === 'email' || field.type === 'dropdown') {
                    const input = form.querySelector(`[name="${field.label}"]`);
                    value = input ? input.value : "";
                } else if (field.type === 'radio') {
                    const checked = form.querySelector(`input[name="${field.label}"]:checked`);
                    value = checked ? checked.value : "";
                }
                responseData.answers[field.label] = value;
            });

            try {
                await addDoc(collection(db, "responses"), responseData);
                alert("✅ Your response has been submitted!");
                form.reset();
            } catch (err) {
                console.error("Error submitting response:", err);
                alert("❌ Failed to submit response.");
            }
        });
    } else {
        formPreview.innerHTML = "<p>Event not found.</p>";
    }
}

showEventDetail();
</script>
</html>